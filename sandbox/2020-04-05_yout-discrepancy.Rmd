---
title: "Discrepancy in Cohort and Job Files"
author: "Suzanne Dufault"
date: "4/20/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE)

library(tidyverse)
library(boxr)
library(kableExtra)
library(knitr)
library(ggthemr)
library(date)
ggthemr(palette = "fresh", layout = "clean")
box_auth()

cohort <- box_read(485768272681)
gan <- box_search("gpp84_3.Rdata") %>% box_read()
han <- box_search("hpp84_3.Rdata") %>% box_read()
san <- box_search("spp84_3.Rdata") %>% box_read()
```

# Brief Intro to End of Employment Dates {.tabset .tabset-pills}

## Original Data Files

There are two places where an employee's termination date may appear. First, as a part of the YOUT variable in the cohort file. The most recent is the YOUT16 variable in the `auto_vs_15.sas7bdat` file.

```{r}
cohort %>% 
  dplyr::select(STUDYNO, YOB, PLANT, YIN16, YOUT16, cod_09, V_ICD, yrin16) %>% 
  head(n = 5) %>% 
  kable(caption = "First few rows of cohort file") %>% 
  kable_styling()
```

The second place is in the job files which have one row per transaction rather than per person.

```{r}
gan %>% 
  filter(STUDYNO == 102763) %>% 
  mutate(DATEOUT.year = date.mdy(DATEOUT)$year) %>% 
  arrange(DATEOUT, DATEIN) %>% 
  kable(caption = "Example rows from a job file.") %>% 
  kable_styling()
```

## Distribution of Discrepancy
They are not clean, there are duplicates, and we recently discovered that a number of the job records have the following odd property. Usually, if the last job record has DATEIN = DATEOUT, that is considered the end of employment for that employee. 

```{r}
temp_jobfiles <- bind_rows(gan, han, san)

temp_jobfiles <- temp_jobfiles %>% 
  dplyr::select(STUDYNO, DATEIN, DATEOUT, HISTCODE, MACH)

temp_dta <- left_join(temp_jobfiles, 
                      cohort)

temp_dta_1970 <- temp_dta %>% 
  group_by(STUDYNO) %>% 
  mutate(final_job_DATEOUT = date.mdy(max(DATEOUT))$year) %>% 
  filter(YOUT16 > 1970)

odd_group <- temp_dta_1970 %>% 
  filter(YOUT16 - final_job_DATEOUT < -2) 
  
```

Out of the `r n_distinct(temp_dta_1970$STUDYNO)` whose YOUT16 occurred after 1970, `r n_distinct(odd_group$STUDYNO)` have YOUT16s more than 2 years prior to their final job DATEOUT (using 2 years as a reasonable margin of error).

Specifically, the distribution of the discrepancy looks like this:

```{r}
odd_group %>% 
  ungroup() %>% 
  transmute(STUDYNO, 
            discrepancy = YOUT16 - final_job_DATEOUT) %>% 
  distinct() %>% 
  ggplot(aes(x = discrepancy)) + 
  geom_histogram() + 
  xlab("YOUT16 - last job history date")
```


## Discrepancy Pattern 

If we look at the last three entries for most of these individuals, we see an odd pattern:

```{r}
odd_group %>% 
  arrange(STUDYNO, DATEOUT, DATEIN) %>% 
  mutate(t = row_number(),
         DATEOUT.year = date.mdy(DATEOUT)$year) %>% 
  filter(t %in% c(max(t), max(t)-1, max(t)-2)) %>% 
  dplyr::select(STUDYNO, DATEIN, DATEOUT, HISTCODE, MACH, YOB, YOUT16, yod09, DATEOUT.year) %>% 
  head(n = 24) %>% 
  kable(digits = 0) %>% 
  kable_styling() %>% 
  collapse_rows(columns = c(1, 6:9))
```

Not all, but many of the individuals have two "OFF" records with one occurring far earlier than the other. 

